    
### 트랜잭션이란

> 데이터베이스의 상태를 변화(쿼리를 통해 db에 접근해서 CRUD 작업을 하는)시키기 위해 수행하는 작업 단위

그리고 여기서 말하는 작업 단위는 프로젝트별로 상황별로 정리하기 나름이다
예시로 어떠한 작업단위를 오늘 일기 작성하기라는 작업단위를 두었다면 하나의 작업단위 내에는 1. 오늘 날씨 데이터를 가져와서 2. 일기를 db에 저장하기
그리고 사용자가 오늘 일기를 작성하는 1,2번을 합친것이 하나의 데이터베이스의 상태를 변화시키기 위해 수행하는 작업단위가 되는것이다.

오늘 일기 작성하기를 하나의 트랜잭션으로 보고 오늘의 일기를 쓰기위해서는 날씨데이터를 가져오고  일기를 쓴걸 데이터베이스에 저장해야한다
그런데 만약에 1번 날씨데이터가져오기에서 문제가 생긴다면 일기를 데이터베이스에 저장해선 안된다
왜냐하면 날씨데이터가 항상 있을것이라는 걸 가정해서 데이터베이스를 구성해두었는데 날씨데이터가 없다면 불완전한 일기데이터가 될 것이다.

만약에 날씨데이터를 가져오지 못하거나 일기를 저장하는 과정에서 문제가 생긴다면 1,2번 작업 둘중에 하나의 작업에 문제가 생긴다면 트랜잭션 전체를 롤백을 시켜버려 이 상황을 해결한다
그래서 하나의 트랜잭션을 정의해두고 1번, 2번처럼 트랜잭션에 속해있는 작업들로 정의를 해둔 다음
1,2번 작업중에 단 하나라도 문제가 생긴다면 이 트랜잭션 자체를 다 취소해버리고 트랜잭션을 실행시키기 이전상태로 되돌리겠다 라고 트랜잭션을 사용할 수 있다.

서비스안에 논리적인 구조들을 트랜잭션으로 잘 설계를 해두면 트랜잭션 전체가 성공했을때 데이터베이스의 상태가 변한다.

### 트랜잭션의 4가지 속성
- 원자성 : 트랜잭션이 db에 모두 반영되거나 모두 반영이 되지 않는 것
- 일관성 : 트랜잭션의 작업처리결과는 항상 일관적이어야한다.(A결과물이 나오는 작업을 했을 때 B결과물이 나오면 안된다)
- 독립성 : 여러 트랜잭션들이 하나의 데이터베이스에 동시작업이 일어날때 끼어들수 없다(한번에 하나의 트랜잭션만 가능)
- 지속성 : 트랜잭션이 성공적으로 완료가 되었다면 변화된 상태가 영구적으로 반영이 되어야한다.

### 트랜잭션의 연산
- 커밋 : 트랜잭션에 속해있는 모든 작업이 성공적으로 완료되었을 때 커밋이 일어나서 데이터베이스의 상태를 변화시킴
- 롤백 : 트랜잭션에 속해있는 작업중 하나라도 문제가 생겼다면 트랜잭션이 발생하기전의 상태로 롤백시켜 버린다.

### 여러 트랜잭션이 경쟁하면 생기는 문제
- 하나의 트랜잭션이 커밋되기 전 다른 트랜잭션이 같은 데이터베이스에 접근해서 작업을 수행한다면 
  - dirty read : A트랜잭션이 데이터베이스를 수정할 때 B트랜잭션이 조회가 가능하도록 열려있었기 때문에 발생하는 문제
  - non repeatable read : 어떤 값에 대해 조회를 2번하는 A트랜잭션 사이에 B트랜잭션이 데이터베이스를 수정하면 A트랜잭션의 입장에서 값이 달라지기 때문에 일관성규칙을 만족시키지 못한다.
  - phantom read : 일정 범위에 대해 조회를 여러번 할때 다른 트랜잭션이 접근해서 데이터베이스를 변경한다면 일관성을 해친다.

### 스프링 트랜잭션 세부설정
- @Transactional 선언적 트랜잭션
- 클래스, 메소드 위에 애노테이션을 추가할 수 있고, 추가된 클래스나 메소드에 트랜잭션 기능이 추가된 프록시 객체가 생성된다.
1. isolation 격리 수준
   - 트랜잭션에서 일관성이 없는 데이터를 허용하는 수준
   - default
   - read_uncommitted (최하위 격리 수준, 제일 헐거운 규약, dirty read 발생 가능)
   - read_committed   (dirty read 방지하지만 non-repeatable read 방지하지못함)
   - repeatable_read  (non-repeatable read 방지, 트랜잭션이 완전히 커밋될때까지 락을걸어서 다른 접근을 막음)
   - serializable     (phantom read 방지)
   - @Transactional(isolation=Isolation.DEFAULT) 방식으로 사용가능
2. propagation 전파 수준
   - 트랜잭션 동작 도중에 다른 트랜잭션을 호출하는 상황
   - 트랜잭션을 시작하거나 기존 트랜잭션에 참여하는 방법에 대해 결정하는 속성값
   - REQUIRED (default 속성 -> 부모 트랜잭션 안에서 함께 수행된다.)
   - SUPPORTS (이미 시작된 트랜잭션이 있다면 포함되어 같이 수행되고, 그렇지 않다면 트랜잭션없이 실행)
   - REQUIRES_NEW (부모트랜잭션안에서 함수B가 동작한다면 자신만의 트랜잭션을 새로만들어서 동작)
   - NESTED (이미 트랜잭션이 있다면 중첩트랜잭션을 실행시킨다.)
     - 일기 작성(부모 트랜잭션) 관련해서 로그(자식 트랜잭션)를 DB에 저장하는 상황
     - 로그저장이 실패한다고해서 일기 작성까지 롤백되면 안된다.
     - 일기작성이 실패한다면 로그작성까지 롤백되어야한다.
3. readonly 속성
   - 트랜잭션을 읽기전용속성으로 지정
   - @Transactional(readOnly=true)
4. 트랜잭션 롤백 예외
   - 예외발생했을 때 트랜잭션 롤백시킬 경우를 설정한다.
   - @Transactional(rollbackFor=Exception.class)
   - @Transactional(noRollbackFor=Exception.class)
5. timeout 속성
   - 일정시간내에 트랜잭션을 끝내지 못하면 롤백
   - @transactional(timeout=10)

